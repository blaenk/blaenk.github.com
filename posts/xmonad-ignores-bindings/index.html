
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>XMonad Ignores Bindings - Jorge Israel Peña</title>
	<meta name="author" content="Jorge Israel Peña">

	
	<meta name="description" content="Media Keys Binding The Problem Bug Hunting Workaround Bug Report Disclaimer: This post is titled to make it easy for people who are experiencing the &hellip;">
	
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, target-densitydpi=device-dpi">

	<link href="" rel="alternate" title="Jorge Israel Peña" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href='/assets/site-182d1574fd7d19504477f66f1499e28f.css' rel='stylesheet' type='text/css' media='screen' />

	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<!--[if lt IE 9]><script async="true" src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <script async='true' src='/assets/site-14f109f94eaaf9e406916b7bf8be360b.js' type='text/javascript'></script>

	
</head>


<body>
	<header id="header" class="inner"><div id="stamp">
  <h1><a href="/">Jorge Israel Peña</a></h1>
  <h4>AKA Blaenk Denum</h4>
</div>
<nav id="main-nav">
	<ul class="main">
	<li><a href="/about">About</a></li>
	<li><a href="/lately">Lately</a></li>
	<li><a href="/projects">Projects</a></li>
	<li><a href="/resume">Résumé</a></li>
	<li><a href="/archives">Archives</a></li>
	<li><a id="search_btn">Search</a></li>
</ul>

	<form class="desk_search" action="http://google.com/search" method="get">
		<input type="text" name="q" results="0" placeholder="Search... (Click 'Search' to hide)" autocomplete="off" spellcheck="false">
		<input type="hidden" name="q" value="site:blaenkdenum.com">
	</form>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
	<li><a href="/about">About</a></li>
	<li><a href="/lately">Lately</a></li>
	<li><a href="/projects">Projects</a></li>
	<li><a href="/resume">Résumé</a></li>
	<li><a href="/archives">Archives</a></li>
	<li><a id="search_btn">Search</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:blaenkdenum.com">
			</form>
		</div>
	</div>
</nav>

</header>
	
	<div id="content" class="inner"><article class="post">
  <h2 class="title"><a href="">XMonad Ignores Bindings</a></h2>
	<div class="entry-content"><ul id="markdown-toc">
  <li><a href="#media-keys">Media Keys</a></li>
  <li><a href="#binding">Binding</a></li>
  <li><a href="#the-problem">The Problem</a></li>
  <li><a href="#bug-hunting">Bug Hunting</a></li>
  <li><a href="#workaround">Workaround</a></li>
  <li><a href="#bug-report">Bug Report</a></li>
</ul>

<p><strong>Disclaimer</strong>: This post is titled to make it easy for people who are experiencing the same problem to find this post. XMonad does <em>not</em> ignore <em>all</em> bindings.</p>

<p>In my <a href="/2013/02/12/terminal-customization/">previous post</a> I talked about how I spent a while configuring my system, specifically urxvt and zsh, in preparation for setting up <a href="http://xmonad.org">XMonad</a>. I’ve finally gotten around to setting up XMonad. One problem in particular stopped me from continuing with the rest of the configuration.</p>

<h2 id="media-keys">Media Keys</h2>

<p>I have a regular keyboard layout, <a href="http://www.daskeyboard.com/model-s-ultimate/">Das Keyboard Model S Ultimate</a>, which lacks media keys (i.e. volume up, down, etc). This wasn’t too much of a problem when I used headsets because most of them have dedicated volume controls. However, I got tired of headsets being rendered useless when any little thing messed up (e.g. microphone, a speaker, etc).</p>

<p>As a result I ended up buying a <a href="http://amzn.com/B00029MTMQ">cheap standalone mic</a> and now use my iPhone’s <a href="http://amzn.com/B004PNZFZ8">Shure SE215-K</a> earbuds for sound on my computer. This is very easy to do given my computer case’ front panel audio connector. Of course, the problem now is that there aren’t any dedicated media keys and having to use a GUI to change the volume is cumbersome.</p>

<p>My solution to this problem in Windows and Mac is to bind the bottom right keys to media keys as follows:</p>

<ul>
  <li>Right Control → Volume Up</li>
  <li>Menu Key → Volume Down</li>
  <li>Right Windows Key → Volume Mute</li>
</ul>

<h2 id="binding">Binding</h2>

<p>Creating these binds is possible on Windows via a registry hack, facilitated using a program such as <a href="http://www.randyrants.com/sharpkeys/">SharpKeys</a>.</p>

<p>On Linux I initially did this using <code>xmodmap</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class=""><span class="line">remove Control = Control_R
</span><span class="line">keycode 105 = XF86AudioRaiseVolume
</span><span class="line">add Control = Control_R
</span><span class="line">
</span><span class="line">keycode 135 = XF86AudioLowerVolume
</span><span class="line">
</span><span class="line">remove mod4 = Super_R
</span><span class="line">keycode 134 = XF86AudioMute
</span><span class="line">add mod4 = Super_R</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Binding to these <code>XF86Audio*</code> keys automatically adds support for these keys in different applications like <a href="http://www.mplayer2.org/">mplayer2</a>, but I wanted system-wide volume support. This is typically accomplished by wiring them up in your given Desktop Environment or Window Manager. So I went ahead and did so in <code>xmonad.hs</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="haskell"><span class="line"><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">xF86XK_AudioMute</span><span class="p">),</span> <span class="n">spawn</span> <span class="s">&quot;amixer -q set Master,0 toggle&quot;</span><span class="p">),</span>
</span><span class="line"><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">xF86XK_AudioLowerVolume</span><span class="p">),</span> <span class="n">spawn</span> <span class="s">&quot;amixer -q set Master,0 5%- unmute&quot;</span><span class="p">),</span>
</span><span class="line"><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">xF86XK_AudioRaiseVolume</span><span class="p">),</span> <span class="n">spawn</span> <span class="s">&quot;amixer -q set Master,0 5%+ unmute&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="the-problem">The Problem</h2>

<p>The problem was that XMonad would only react to the Right Control key (Volume Up). However, <code>xev</code> correctly interpreted the keys as having been bound to the <code>XF86Audio*</code> keys. I was really confused as to why the binds apparently did work at the system level but only one of them worked at the window manager level.</p>

<p>To rule out that it wasn’t something with the system-level (xmodmap) binds, I decided to check if it worked in <a href="http://awesome.naquadah.org/">Awesome</a>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="lua"><span class="line"><span class="n">awful</span><span class="p">.</span><span class="n">key</span><span class="p">({},</span> <span class="s2">&quot;</span><span class="s">XF86AudioLowerVolume&quot;</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="n">awful</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">spawn</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">amixer -q set Master,0 5%- unmute&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
</span><span class="line"><span class="n">awful</span><span class="p">.</span><span class="n">key</span><span class="p">({},</span> <span class="s2">&quot;</span><span class="s">XF86AudioRaiseVolume&quot;</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="n">awful</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">spawn</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">amixer -q set Master,0 5%+ unmute&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
</span><span class="line"><span class="n">awful</span><span class="p">.</span><span class="n">key</span><span class="p">({},</span> <span class="s2">&quot;</span><span class="s">XF86AudioMute&quot;</span><span class="p">,</span> <span class="k">function</span> <span class="p">()</span> <span class="n">awful</span><span class="p">.</span><span class="n">util</span><span class="p">.</span><span class="n">spawn</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">amixer set Master,0 toggle&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span> <span class="k">end</span><span class="p">),</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Indeed it worked perfectly. So now I had narrowed down the problem to XMonad.</p>

<h2 id="bug-hunting">Bug Hunting</h2>

<p>Eventually I decided to stop by <code>#xmonad</code> on freenode. There I found Paul Fertser who spent the next ~6 hours helping me track down what he figured to be a bug in XMonad. I told him that the system-level binds did work, but not in XMonad. I showed him my binds using <code>xmodmap -pke</code>.</p>

<p>He noticed that the <code>XF86Audio*</code> keys were bound twice: once by default by XKB (<code>xmodmap</code>’s more modern replacement) bound to the keycodes I would have if my keyboard had media keys, and bound again to the keys I chose (the bottom right keys). He then hypothesized that XMonad wasn’t grabbing the keys at all due to Xlib limitations. Specifically, the <code>XKeysymToKeycode</code> function only returns one keycode per key, biased towards lower keycodes, presumably due to an increasing iterative search of the keycodes for a match.</p>

<p>This theory accounted for why the Right Control (Volume Up) bind did work and not the others. What happened was that Right Control’s keycode was lower than the duplicate bind’s keycode. As a result, when XMonad used <code>XKeysymToKeycode</code> it retrieved the correct keycode. The other two binds, however, have higher keycodes than the default-bound ones, and so <code>XKeysymToKeycode</code> returned the first (lower) keycode it found and as a result XMonad never even knew of the other binds’ existence.</p>

<p>To test this theory, Paul had me run <a href="http://en.wikipedia.org/wiki/Ltrace"><code>ltrace</code></a> on XMonad to see which keys XMonad grabbed. The output of this clearly showed that XMonad only grabbed the keys with the lower keycodes.</p>

<h2 id="workaround">Workaround</h2>

<p>Now that we were pretty sure of the cause of this, the workaround was to remove the other keycodes (for keys I didn’t even have on my keyboard). At this time I decided I might as well switch over to XKB. The first order of business was to <a href="http://unix.stackexchange.com/a/65600/10163">dump my XKB map</a>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"><span class="nv">$ </span>setxkbmap -print &gt; ~/.xkb/keymap/mymap
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then I created a <code>~/.xkb/symbols/volume_keys</code> file to store my media key binds. It took me a long while to figure out how to remove/unbind the default-bound keys. One problem was that XKB sets different aliases for keys. For example, <code>&lt;I0D&gt;</code> (I guess that’s a media key) was aliased to <code>&lt;MUTE&gt;</code>. I looked around in <code>/usr/share/X11/xkb/rules/evdev</code> to see what was aliased and made sure to unbind those too. As for unbinding, at first Paul suggested to bind the keys to <code>NoSymbol</code> but that apparently had no effect. Eventually I found out it was possible with <a href="http://madduck.net/docs/extending-xkb/#attaching_symbols_to_keys"><code>VoidSymbol</code></a>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class=""><span class="line">partial modifier_keys
</span><span class="line">xkb_symbols "volume_keys" {
</span><span class="line">  // mute
</span><span class="line">  replace key &lt;MUTE&gt; { [ VoidSymbol ] };
</span><span class="line">  replace key &lt;I0D&gt; { [ VoidSymbol ] };
</span><span class="line">
</span><span class="line">  // lower volume
</span><span class="line">  replace key &lt;VOL-&gt; { [ VoidSymbol ] };
</span><span class="line">  replace key &lt;I0E&gt; { [ VoidSymbol ] };
</span><span class="line">
</span><span class="line">  // raise volume
</span><span class="line">  replace key &lt;VOL+&gt; { [ VoidSymbol ] };
</span><span class="line">  replace key &lt;I0F&gt; { [ VoidSymbol ] };
</span><span class="line">
</span><span class="line">  replace key &lt;RCTL&gt; { [ XF86AudioRaiseVolume ] };
</span><span class="line">  replace key &lt;MENU&gt; { [ XF86AudioLowerVolume ] };
</span><span class="line">  replace key &lt;RWIN&gt; { [ XF86AudioMute ] };
</span><span class="line">  replace key &lt;RALT&gt; { [ Multi_key ] };
</span><span class="line">};</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Now I loaded my XKB map in <code>~/.xinitrc</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line">xkbcomp -I<span class="nv">$HOME</span>/.xkb ~/.xkb/keymap/mymap <span class="nv">$DISPLAY</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I restarted XMonad with <code>Mod-Shift-Q</code> (so that <code>~/.xinitrc</code> is rerun) and everything now worked perfectly.</p>

<h2 id="bug-report">Bug Report</h2>

<p>Over the course of my transition to XKB, Paul found that there was already <a href="https://code.google.com/p/xmonad/issues/detail?id=273">an issue</a> opened back in 2009 concerning this. The issue report has a patch attached that fixes this, but the patch has yet to be applied to XMonad. Paul suggested I try the patch myself and communicate my results back to the issue report. So I went ahead and got XMonad and XMonadContrib from the darcs repository, ran a simple <code>darcs apply keycode.dpatch</code>, and installed each with a <code>--prefix</code> to prevent clashing with the ones already installed with pacman. Indeed, the patch worked perfectly.</p>

</div>


<div class="meta">
	<div class="date">












  





  

<time class="" datetime="2013-02-24T22:25:00-08:00" pubdate data-updated="true">February 24<span>th</span>, 2013</time></div>
	<div class="tags">


	<a class='category' href='/categories/awesome/'>Awesome</a>, <a class='category' href='/categories/linux/'>Linux</a>, <a class='category' href='/categories/xmonad/'>XMonad</a>


</div>
	
</div>

</article>

	


<section id="comment">
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>

</div>
	<footer id="footer">












  





  

{ <span id="generated">generated <time class="" datetime="2013-03-02T00:10:46-08:00">March 2<span>nd</span>, 2013</time></span> }
</footer>
	

<script async="true" type="text/javascript">
      var disqus_shortname = 'blaenkdenum';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blaenkdenum.com/posts/xmonad-ignores-bindings/';
        var disqus_url = 'http://blaenkdenum.com/posts/xmonad-ignores-bindings/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script async="true" type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-37339861-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>




<!--MathJax CDN-->
<script async="true" type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  MathJax.Hub.Config({
    messageStyle: "none",
    styles: {
      ".MathJax_Display": {
        "font-weight": "normal"
      },
      ".MathJax": {
        "font-weight": "normal"
      }
    },
    showMathMenu: false
  });
</script>

</body>
</html>
